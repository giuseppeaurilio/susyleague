<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="paho-mqtt.js" type="text/javascript"></script>
<script type="text/javascript">
	

  // Create a client instance
  //client = new Paho.MQTT.Client("m20.cloudmqtt.com", 35317,"client_id");
  //client = new Paho.MQTT.Client("m20.cloudmqtt.com", 35317, "web_pippo" );
//client = new Paho.MQTT.Client("localhost", 1883, "web_" + parseInt(Math.random() * 100, 10));
var d = new Date();
var t = d.getTime();
var client_name="web_pippo"+t;
client = new Paho.MQTT.Client("broker.mqttdashboard.com", 8000, client_name );

  // set callback handlers
  client.onConnectionLost = onConnectionLost;
  client.onMessageArrived = onMessageArrived;
  var options = {
    useSSL: false,
    //userName: "pippo",
    //password: "baudo",
    onSuccess:onConnect,
    onFailure:doFail
  }

  // connect the client
  client.connect(options);

  // called when the client connects
  function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    console.log("onConnect");
    client.subscribe("asta_susyleague");

  }

  function doFail(e){
    console.log(e);
  }

  // called when the client loses its connection
  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("onConnectionLost:"+responseObject.errorMessage);
    }
  }

  // called when a message arrives
  function onMessageArrived(message) {
	var message_json=message.payloadString;
	  
    console.log("onMessageArrived:"+message_json);
	
	var myObj = JSON.parse(message_json);
	$("#risposta").val($("#risposta").val()+myObj.text.nome_giocatore + "," +myObj.text.offerta+ ","+ myObj.user_name +"\r");
    //$("#risposta").val($("#risposta").val()+message.payloadString+"-"+message.destinationName+"\r");
    //$("#risposta").val="pippo";

  }
  
  
  $(document).ready(function(){
    $("#send").click(function(){
		

	var msg_text=$("#msg_text").val()
	var utente=$("#utente").val()
	var testo={"id_giocatore":21, "nome_giocatore":msg_text, "offerta":32};
	var myObj_message = { "text":testo, "id":45, "type":2, "user_id":3, "user_name":utente };
	var myJSON_message = JSON.stringify(myObj_message);	
    //message = new Paho.MQTT.Message(utente + "," + msg_text);
    message = new Paho.MQTT.Message(myJSON_message);
	message.destinationName = "asta_susyleague";
    client.send(message);
    
    });
    
});


</script>




<body>

<form >
Utente: <input type="text" name="utente" value="" id="utente"><br>
Messaggio: <input type="text" name="messaggio" value="" id="msg_text"><br>
<button type="button" id="send" >invia</button>
</form>

<textarea rows="40" cols="50" id="risposta">
</textarea>

</body>
</html>


